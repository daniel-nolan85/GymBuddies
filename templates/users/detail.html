{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}{{ account.user }}{% endblock %}

{% block content %}
{% if account.user.is_active %}
    <!--================Home Banner Area =================-->
    <section class="banner_area">
        <div class="banner_inner d-flex align-items-center">
            <div class="overlay bg-parallax" data-stellar-ratio="0.9" data-stellar-vertical-offset="0" data-background=""></div>
            <div class="container">
                <div class="banner_content text-center">
                    <h2>{{ account.user }}</h2>
                </div>
            </div>
        </div>
    </section>
    <!--================End Home Banner Area =================-->
    <main>
        <div class="main-section">
            <div class="container">
                <div class="main-section-data">
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="main-left-sidebar">
                                <div class="user_profile">
                                    <div class="user-pro-img" data-toggle="modal" data-target="#profilePicModal" data-pic="{{ account.avatar.url }}">
                                        <img class="d-block border border-dark rounded-circle img-fluid mx-auto profile-image" src="{{ account.avatar.url }}" alt="" style="cursor: pointer;">
                                    </div><!--user-pro-img end-->

                                    <ul class="social_links">
                                        <li>
                                            Buddies
                                            <span class="badge badge-primary">{{ account.get_buddies_num}}</span>
                                        </li>
                                        <li>
                                            Posts
                                            <span class="badge badge-primary">{{ account.get_posts_num }}</span>
                                        </li>
                                        <li>
                                            High Fives given
                                            <span class="badge badge-primary">{{ account.get_high_fives_given_num }}</span>
                                        </li>
                                        <li>
                                            High Fives received
                                            <span class="badge badge-primary">{{ account.get_high_fives_received_num }}</span>
                                        </li>
                                        <li>
                                            Buddy Since
                                            <span>{{ account.created|date }}</span>
                                        </li>
                                    </ul>
                                </div><!--user_profile end-->
                            </div><!--main-left-sidebar end-->
                        </div>
                        <div class="col-lg-9">
                            <div class="main-ws-sec">
                                <div class="buddy-btn" style="float: right;">
                                    {% if account.user not in rel_receiver and account.user not in rel_sender %}
                                        <form action="{% url 'users:send_invite' %}" method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="profile_pk" value="{{ account.pk }}">
                                            <button type="submit" class="follow" style="border: none;"><i class="fas fa-plus pr-2"></i>Buddy Up!</button>
                                        </form>
                                    {% elif account.user in rel_receiver and request.user not in account.buddies.all %}
                                        <button style="border: none; color: #b2b2b2;"><i class="fas fa-running pr-2"></i>Buddies pending...</button>
                                    {% elif request.user in account.buddies.all %}
                                        <form action="{% url 'users:remove_buddy' %}" method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="profile_pk" value="{{ account.pk }}">
                                            <button type="submit" class="message-us" style="border: none;"><i class="fas fa-minus pr-2"></i>Buddy Out!</button>
                                        </form>
                                    {% endif %}
                                </div>
                                {% if request.user in account.buddies.all %}
                                <div>
                                    <div class="message-btn" style="float: right;">
                                        <button data-toggle="modal" data-target="#private-message" type="submit" style="border: none; color: #fff;"><i class="fas fa-envelope"></i></i>Message</button>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- private message modal -->
                                <div class="modal" tabindex="-1" id="private-message">
                                    <div class="modal-dialog" style="width: 415px">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Send a message</h5>
                                            </div>
                                            <form id="msgForm" action="" method="post" class="p-3">
                                                <div class="modal-body">
                                                    {% csrf_token %}
                                                    {{ form.as_p }}
                                                </div>
                                                <div class="modal-footer">
                                                    <div class="message-btn active">
                                                        <button id="msgBtn" type="button"><i class="fas fa-edit"></i>Send</button>
                                                        <button type="button" data-dismiss="modal">Cancel</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <!-- end of modal -->

                                <div class="user-tab-sec rewivew">
                                    <div class="row">
                                        <h3>{{ account.first_name}} {{ account.last_name}}</h3>
                                    </div>

                                    <div class="tab-feed st2 settingjb">
                                        <ul>
                                            <li data-tab="feed-dd" class="active">
                                                <a href="#" title="">
                                                    <img src="{static 'images/ic1.png' %}" alt="">
                                                    <span>Posts</span>
                                                </a>
                                            </li>
                                            <li data-tab="info-dd">
                                                <a href="#" title="">
                                                    <img src="{static 'images/ic2.png' %}" alt="">
                                                    <span>Info</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </div><!-- tab-feed end-->
                                </div><!--user-tab-sec end-->
                                <!-- **** FEED **** -->
                                <div class="product-feed-tab current" id="feed-dd">
                                    <div class="posts-section infinite-container">
                                        {% if len_posts %}
                                            {% for post in posts %}
                                                <div class="post-bar infinite-item" data-id="{{ post.id }}">
                                                    <div class="post_topbar">
                                                        <div class="usy-dt mb-2">
                                                            <img src="{{ post.author.avatar.url }}" alt="" style="height: 30px;">
                                                            <div class="usy-name">
                                                                <h3><a href="#">{{ post.author.user }}</a></h3>
                                                                <span><img src="{% static 'images/clock.png' %}" alt="">{{ post.created|timesince }}</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="job_descp">
                                                        {% if post.image %}
                                                            <div class="post-image-box mt-3">
                                                                <img src="{{ post.image.url }}" alt="" width="500">
                                                            </div>
                                                            <br>
                                                        {% endif %}
                                                        {% if post.video %}
                                                            <div class="post-video-box mt-3">
                                                                <video width="200" controls>
                                                                    <source src='{{ MEDIA_URL }}{{ post.video }}' type='video/mp4'>
                                                                    Your browser does not support the video tag.
                                                                </video>
                                                            </div>
                                                        {% endif %}
                                                        {% if post.content|length > 150 %}
                                                            <p id="half-{{ post.id }}" class="mt-3">{{ post.content|truncatechars:150 }}<a data-id="{{ post.id }}" href="javascript:void();" class="show-hide-txt"> view more</a></p>
                                                            <p id="full-{{ post.id }}" class="mt-3" style="display: none;">{{ post.content }}</p>
                                                        {% else %}
                                                            <p class="mt-3">{{ post.content }}</p>
                                                        {% endif %}

                                                        <ul class="skill-tags">
                                                            <li><a href="{% url 'posts:category_detail' pk=post.category.id slug=post.category.slug %}">{{ post.category.title }}</a></li>
                                                        </ul>

                                                    </div>
                                                    <div class="job-status-bar">
                                                        <div class="like-com">
                                                            <p class="comment-count{{ post.id }}" style="color: #000;"><i class="fas fa-comment-alt mr-3"></i>{{ post.comments_num }}</p>
                                                            <form action="{% url 'posts:high_fived' %}" method="post" class="high_five-form" id="{{ post.id }}">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="post_id" value="{{ post.id }}">

                                                                <button type="submit" class="high_five-btn{{ post.id }}" style="background: none; padding: 0px; border: none; display: inline; font-size: 14px;"><i class="fas fa-hand-sparkles"></i>
                                                                    {% if profile not in post.high_fived.all %}
                                                                        High Five
                                                                    {% else %}
                                                                        Take Back
                                                                    {% endif %}
                                                                </button>
                                                                <p class="high_five-count{{ post.id }} ml-3" style="display: inline; color: #000;">{{ post.high_fives_num }}</p>
                                                            </form>
                                                        </div>
											        </div>
                                                    <button type="button" class="com com-btn" style="background: none; padding: 0px; border: none;"><i class="fas fa-chevron-down"></i></button>
                                                    <div class="com-list" id="comList" style="display: none;">
                                                        {% if post.comment_set.all %}
                                                            {% for comment in post.comment_set.all %}
                                                                <div class="comCard" data-id="{{ comment.id }}">
                                                                    <div class="commenter">
                                                                        <div>
                                                                            {% if comment.user.user == request.user %}
                                                                                <a href="{% url 'users:my_profile' %}" class="view-more-pro">
                                                                                    <img src="{{ comment.user.get_avatar }}" class="mr-3 com-pic">
                                                                                    <span id="com-name">{{ comment.user.user }}</span>
                                                                                </a>
                                                                            {% else %}
                                                                                <a href="{% url 'users:profile_detail' slug=comment.user.slug sender_id=request.user.id %}" class="view-more-pro">
                                                                                    <img src="{{ comment.user.get_avatar }}" class="mr-3">
                                                                                    <span>{{ comment.user.user }}</span>
                                                                                </a>
                                                                            {% endif %}

                                                                            <p class="ml-1">{{ comment.created|timesince }}</p>
                                                                        </div>
                                                                        <div>
                                                                            {% if comment.user.user == request.user %}
                                                                                <div class="ed-opts">
                                                                                    <ul class="bk-links">
                                                                                        <li><a href="" data-toggle="modal" data-target="#delete-com{{comment.id}}"><i class="fas fa-trash"></i></a></li>
                                                                                        <!-- modal -->
                                                                                        <div class="modal fade" id="delete-com{{comment.id}}" role="dialog">
                                                                                            <div class="modal-dialog">
                                                                                                <div class="modal-content">
                                                                                                    <!-- modal header -->
                                                                                                    <div class="modal-header">
                                                                                                        <h3 class="modal-title" style="color: #fff; font-weight: bold;">Do you really want to delete?</h3>
                                                                                                    </div>
                                                                                                    <!-- modal body -->
                                                                                                    <div class="modal-body" style="padding: 20px;"><p>{{ comment.body }}</p></div>
                                                                                                    <!-- modal footer -->
                                                                                                    <div class="modal-footer">
                                                                                                        <button id="comDelete" type="submit" class="active" data-id="{{ comment.id }}">Yes, Delete</button>
                                                                                                        <button type="button" data-dismiss="modal">Cancel</button>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                        <!-- end of modal -->
                                                                                    </ul>
                                                                                </div>
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                    <div class="job_descp">
                                                                        {% if comment.body|length > 150 %}
                                                                            <p id="half-{{ comment.id }}" class="mb-3 ml-5">{{ comment.body|truncatechars:150 }}<a data-id="{{ comment.id }}" href="javascript:void();" class="show-hide-com"> view more</a></p>
                                                                            <p id="full-{{ comment.id }}" class="mb-3 ml-5" style="display: none;">{{ comment.body }}</p>
                                                                        {% else %}
                                                                            <p class="mb-3 ml-5">{{ comment.body }}</p>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </div>
                                                    <div class="post-comment">
                                                        <div class="comment_box mt-2">
                                                            <form action="{% url 'posts:comment' %}" method="post" class="comment_form" id="addComForm">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="post_id" value={{ post.id }}>
                                                                <input type="hidden" name="comment_id" value={{ comment.id }}>
                                                                {% comment_tag %}
                                                                <button id="addComBtn" type="button" data-id="{{ comment.id }}">Send</button>
                                                            </form>
                                                        </div>
                                                    </div><!--post-comment end-->
                                                </div><!--post-bar end-->
                                            {% endfor %}
                                        {% else %}
                                            <h1>No posts</h1>
                                        {% endif %}
                                    </div><!--posts-section end-->
                                </div><!--product-feed-tab end-->
                                <!-- **** END OF FEED **** -->

                                <!-- **** INFO **** -->
                                <div class="product-feed-tab" id="info-dd">
                                    <div class="star-descp">
                                        <span>{{ account.location }}</span>
                                        <span>{{ account.birthday }}</span>
                                    </div><!--star-descp end-->
                                    <div class="user-profile-ov">
                                        <p>{{ account.bio }}</p>
                                    </div><!--user-profile-ov end-->
                                </div><!--product-feed-tab end-->
                                <!-- **** END OF INFO **** -->
                            </div><!--main-ws-sec end-->
                        </div>
                    </div>
                </div><!-- main-section-data end-->
            </div>
        </div>
    </main>
    <!-- Profile Pic Modal -->
    <div class="modal fade" id="profilePicModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body text-center" id="modal-body"></div>
                <div class="modal-footer message-btn">
                    <button type="button" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/jquery.waypoints.min.js' %}"></script>
	<script src="{% static 'js/infinite.min.js' %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- view profile pic -->
    <script>
        $(document).on('click', '.profile-image', function(){
            const modalBody = document.getElementById('modal-body')
            const profileImage = document.getElementsByClassName('user-pro-img')
            const pic = $(profileImage).attr('data-pic')
            modalBody.innerHTML = `<img src="${pic}" width=500>`
        })
    </script>

    <!-- send message -->
    <script>
        $(document).ready(function() {

            $('.modal-content').on('click', '#msgBtn', function() {
                console.log('click')

                var serializedData = $('#msgForm').serialize();
                var url = window.location;

                $.ajax({
                    url: url,
                    data: serializedData,
                    type: 'POST',
                    success: function(response) {
                        $('#private-message').modal('hide');$('body').removeClass('modal-open');$('.modal-backdrop').remove();
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top',
                            showConfirmButton: true,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        })
                        Toast.fire({
                            icon: 'success',
                            title: 'Message sent'
                        })
                    },
                    error: function(response) {
                        console.log('error', response)
                    }
                })
            });
		});
    </script>

    <!--	add comments-->
	<script>
		$(document).ready(function() {

			$('.post-comment').on('click', '#addComBtn', function() {

                var serializedData = $(this).closest("form").serialize();
                console.log('click')
                var dataId = $(this).data('id');

				var comment_id = $(this).closest("form").find("input[name=comment_id]").val()
				console.log(comment_id)
				console.log($(this).closest(".post-comment").prev(".com-list").find(".comCard:last").data('id'))
				var comments_div = $(this).closest(".post-comment").prev(".com-list");
				var form = $(this).closest("form");

				const post_id = $('.post-bar').data('id')
				let res;
                const commentsNum = $(`.comment-count${post_id}`).text()
                const trimCount = parseInt(commentsNum)

				var avatar = $('.com-pic').attr('src');
				var name = $('#com-name').text();

                $.ajax({
                    url: /comment/,
                    data: serializedData,
                    type: 'POST',
                    success: function(response) {
  						console.log(response.comment)
						$(comments_div).append('<div class="comCard" data-id="' + response.comment.id + '"><div class="commenter"><div><a href="{% url 'users:my_profile' %}" class="view-more-pro"><img src="' + avatar + '" style="height: 30px;" class="mr-3"><span>' + name + '</span></a><p class="ml-1" style="display: inline-block; color: #b2b2b2;">' + "just now" + '</p></div><div><div class="ed-opts"><ul class="bk-links"><li><a href="" data-toggle="modal" data-target="#delete-com' + response.comment.id + '"><i class="fas fa-trash"></i></a></li><div class="modal fade" id="delete-com' + response.comment.id + '" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" style="color: #fff; font-weight: bold;">Do you really want to delete?</h3></div><div class="modal-body" style="padding: 20px;"><p>' + response.comment.body + '</p></div><div class="modal-footer"><button id="comDelete" type="submit" class="active" data-id="' + response.comment.id + '">Yes, Delete</button><button type="button" data-dismiss="modal">Cancel</button></div></div></div></div></ul></div></div></div><p class="mb-3 ml-5">' + response.comment.body + '</p></div>')
                        res = trimCount + 1
						$(`.comment-count${post_id}`).text(res).prepend('<i class="fas fa-comment-alt mr-3"></i>')

                    	const Toast = Swal.mixin({
                                toast: true,
                                position: 'top',
                                showConfirmButton: true,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        })
                            Toast.fire({
                                icon: 'success',
                                title: 'Comment added'
                            })
                    },
                    error: function(error) {
                        console.log('error')
                    }
                })

                form.trigger("reset");
            });
		});
	</script>

	<!--	delete comments-->
	<script>
        $(document).ready(function() {
			var csrfToken = $('input[name=csrfmiddlewaretoken]').val();

            $('.com-list').on('click', '#comDelete', function() {


                var dataId = $(this).data('id');
                console.log(dataId)

                $.ajax({
                    url: '/delete-comment/' + dataId,
                    data: {
                        csrfmiddlewaretoken: csrfToken,
                        id: dataId
                    },
                    type: 'post',
                    dataType: 'json',
                    success: function() {
                    	console.log('success')
                        $('.comCard[data-id="' + dataId + '"]').remove()
                        $('#delete-com{{comment.id}}').modal('hide');$('body').removeClass('modal-open');$('.modal-backdrop').remove();
                    	const Toast = Swal.mixin({
                                toast: true,
                                position: 'top',
                                showConfirmButton: true,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        })
                        Toast.fire({
                            icon: 'error',
                            title: 'Comment deleted'
                        })
                    },
                    error: function(error) {
                        console.log('error')
                    }
                })
            });
        });
    </script>

    <!-- view more posts -->
   <script type="text/javascript">
    $(document).on('click', function(){
        $(".show-hide-txt").click(function(){
            var id = $(this).data("id");
            $("#half-"+id).hide();
            $("#full-"+id).show();
        });
   });
   </script>

    <!-- view more comments -->
   <script type="text/javascript">
     $(document).on('click', function(){
       $(".show-hide-com").click(function(){
            var comId = $(this).data("id");
            $("#half-"+comId).hide();
            $("#full-"+comId).show();
        });
      });
   </script>

<!-- high five and take back -->
  <script type="text/javascript">
  $(document).on('click', function(){
		$('.high_five-form').submit(function(e){

          e.preventDefault()

          const post_id = $(this).attr('id')

          const high_fiveText = $(`.high_five-btn${post_id}`).text()
          const trim = $.trim(high_fiveText)

          const url = $(this).attr('action')

          let res;
          const high_fives = $(`.high_five-count${post_id}`).text()
          const trimCount = parseInt(high_fives)

          $.ajax({
              type: 'POST',
              url: url,
              data: {
                  'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                  'post_id': post_id,
              },
              success: function(response) {
                  if(trim === 'Take Back') {
                      $(`.high_five-btn${post_id}`).text('High Five').prepend('<i class="fas fa-hand-sparkles"></i>')
                      res = trimCount - 1
                  } else {
                      $(`.high_five-btn${post_id}`).text('Take Back').prepend('<i class="fas fa-hand-sparkles"></i>')
                      res = trimCount + 1
                  }
                  $(`.high_five-count${post_id}`).text(res)
              },
              error: function(response) {
                  console.log('error', response)
              }
          })
      })
		});
	</script>

<!-- show/hide comments-->
	<script>
		$(document).on('click', '.com-btn', function(){
			$("i", this).toggleClass("fas fa-chevron-down fas fa-chevron-up");

			if($("i", this).hasClass('fa-chevron-up')) {
				$(this).next(".com-list").show("slow");
			} else {
				$(this).next(".com-list").hide("slow");
			}
		});
	</script>

    <script>
        if ( window.history.replaceState ) {
            window.history.replaceState( null, null, window.location.href );
        }
    </script>
{% else %}
    <section class="banner_area">
        <div class="banner_inner d-flex align-items-center">
            <div class="overlay bg-parallax" data-stellar-ratio="0.9" data-stellar-vertical-offset="0" data-background=""></div>
            <div class="container">
                <div class="banner_content text-center">
                    <h2>This buddy is deactivated</h2>
                </div>
            </div>
        </div>
    </section>
{% endif %}
{% endblock %}